#!/usr/bin/env bash
set -o errexit
set -o nounset

print_heading(){
  local -r blue=$(tput setaf 4)
  local -r green=$(tput setaf 2)
  local -r normal=$(tput sgr0)
  local -r heading=$1
  local -r surround="${blue}########################${normal}"
  printf "%s %s %s\n" "$surround" "${green}${heading}${normal}" "$surround"
}
brew_update(){
  if hash brew &>/dev/null; then
    brew update
    brew upgrade
    brew upgrade --cask --greedy
    brew autoremove
    brew cleanup --prune 180
    brew doctor
  else
    echo "The 'brew' command is not installed on this system."
    echo "Not updating Homebrew packages."
  fi
}
app_store_update(){
  if hash mas &>/dev/null; then
    mas list
    mas upgrade
  else
    echo "The 'mas' command is not installed on this system."
    echo "Not updating App Store packages."
  fi
}
fish_update(){

  if hash fish &>/dev/null; then
    fish --command="fisher update"
  else
    echo "The 'fish' command is not installed on this system."
    echo "Not updating fisher packages."
  fi
}
neovim_update(){
  if hash nvim &>/dev/null; then
    nvim --headless +PlugUpgrade +qall
    echo "\n"
    nvim --headless +PlugUpdate +qall
    echo "\n"
    # TODO @alex figure out if there  is a better place/way to install taskwiki python dependencies (maybe done by vim-plug)
    # both python packages installed below are used by taskwiki
    pip3 install --upgrade pynvim
    # FIXME The use of a `pip3` might break in other OS's. Maybe we should try to handle this somehow and even default to pip?
    pip3 install --upgrade packaging
  else
    echo "The 'nvim' command is not installed on this system."
    echo "Not updating Vim Plug packages for Neovim."
  fi
}
tmux_update(){
  if hash tmux &>/dev/null; then
    if [ -f ~/.tmux/plugins/tpm/bin/update_plugins ]; then 
      ~/.tmux/plugins/tpm/bin/update_plugins all
    else
      echo "The 'update_plugins' command is not installed on this system."
      echo "Not updating Tmux plugins with TPM."
    fi
  else
    echo "The 'tmux' command is not installed on this system."
    echo "Not updating Tmux plugins."
  fi
}
pipx_update(){
  if hash pipx &>/dev/null; then
    pipx upgrade-all
  else
    echo "The 'pipx' command is not installed on this system."
    echo "Not updating Pipx Python Apps."
  fi
}
main(){
  print_heading "Homebrew - Update"
  brew_update

  print_heading "Pipx - Update"
  pipx_update

  print_heading "App Store - Update"
  app_store_update

  print_heading "Fish Shell - Fisher Plugin Manager - Update"
  fish_update

  print_heading "NeoVim - Vim Plug - Update"
  neovim_update

  print_heading "Tmux - Tmux Plugin Manager (aka TMP) - Update"
  tmux_update

  print_heading "All updates terminted successfully"
}

main "$@"
